# Nginx configuration for milkcrate with multi-website support
#
# USE CASE: Multi-website server where you want to run OTHER websites alongside milkcrate
#
# SETUP REQUIRED:
# 1. In docker-compose.yml change Traefik port "80:80" to "8081:80" (nginx will proxy to 8081).
# 2. Install nginx: sudo apt install nginx
# 3. Copy this file: sudo cp /opt/milkcrate/_server/milkcrate.conf /etc/nginx/sites-available/milkcrate
# 4. Enable: sudo ln -sf /etc/nginx/sites-available/milkcrate /etc/nginx/sites-enabled/
# 5. Test: sudo nginx -t
# 6. Reload: sudo systemctl reload nginx
#
# This configuration allows:
# - milkcrate apps accessible via Traefik (proxied through nginx)
# - Other websites can use additional server blocks (see examples below)
# - Nginx handles SSL/TLS for all sites
#
# NOTE: install_nginx.sh generates its own config with server_name _ (any hostname).
# This file is for manual setup when you want a specific domain or to customize.

# Main server block - routes ALL traffic through Traefik (milkcrate apps)
server {
    listen 80;
    server_name yourdomain.com;  # Change to your domain; use _ to accept any hostname

    # Increase buffer sizes to handle large headers (cookies, auth tokens, etc.)
    client_header_buffer_size 8k;
    large_client_header_buffers 8 32k;
    proxy_buffer_size 16k;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 32k;

    # All traffic proxies to Traefik on port 8081
    # Traefik routes to milkcrate admin (/admin, /login, etc.) or deployed apps
    location / {
        proxy_pass http://127.0.0.1:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }
}

# Example: Additional website #1 (WordPress, static site, etc.)
# Uncomment and modify for your other websites
#
# server {
#     listen 80;
#     server_name blog.hostname.com;
#
#     location / {
#         proxy_pass http://127.0.0.1:3000;  # Your other website's port
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# Example: Additional website #2
#
# server {
#     listen 80;
#     server_name shop.hostname.com;
#
#     location / {
#         proxy_pass http://127.0.0.1:4000;  # Another website's port
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }